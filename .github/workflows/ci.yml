name: CI

on:
  push:
    branches:
    - master
    - develop
  pull_request:
    branches:
    - master
    - develop

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
        cache: true
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: "20.x"
        cache: "npm"
        cache-dependency-path: frontend/package-lock.json

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          build-essential \
          pkg-config

    - name: Install Task CLI
      run: go install github.com/go-task/task/v3/cmd/task@latest

    - name: Install Wails v3
      run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

    - name: Install frontend dependencies
      run: npm ci
      working-directory: frontend

    - name: Generate bindings
      run: wails3 generate bindings

    - name: Build frontend
      run: npm run build
      working-directory: frontend

    - name: Run backend tests
      run: task test:backend

    - name: Upload coverage
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.out
        flags: backend
      continue-on-error: true

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
        cache: true
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: "20.x"
        cache: "npm"
        cache-dependency-path: frontend/package-lock.json

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          build-essential \
          pkg-config

    - name: Install Wails v3
      run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

    - name: Install frontend dependencies
      run: npm ci
      working-directory: frontend

    - name: Generate bindings
      run: wails3 generate bindings

    - name: TypeScript type check
      run: npx tsc --noEmit
      working-directory: frontend

    - name: Run frontend tests
      run: npm test -- run
      working-directory: frontend

    - name: Build frontend
      run: npm run build
      working-directory: frontend

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
        cache: true
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: "20.x"
        cache: "npm"
        cache-dependency-path: frontend/package-lock.json

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          build-essential \
          pkg-config

    - name: Install Wails v3
      run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

    - name: Install frontend dependencies
      run: npm ci
      working-directory: frontend

    - name: Generate bindings
      run: wails3 generate bindings

    - name: Build frontend
      run: npm run build
      working-directory: frontend

    - name: Lint Go code
      uses: golangci/golangci-lint-action@v9
      with:
        version: latest
      continue-on-error: true

    - name: Lint frontend code
      run: npm run lint
      working-directory: frontend

  build-verify:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - name: linux
          os: ubuntu-latest
        - name: windows
          os: windows-latest
        - name: macos
          os: macos-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
        cache: true
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: "20.x"
        cache: "npm"
        cache-dependency-path: frontend/package-lock.json

    - name: Install Linux dependencies
      if: matrix.name == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          build-essential \
          pkg-config

    - name: Install Task CLI
      run: go install github.com/go-task/task/v3/cmd/task@latest

    - name: Install Wails v3
      run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

    - name: Build application
      run: task build
