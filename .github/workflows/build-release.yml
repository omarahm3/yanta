name: Build Release Artifacts

on:
  workflow_call:
    inputs:
      version:
        description: 'Version string (e.g., 1.9.3 or 0.0.0-test.123)'
        required: true
        type: string
      artifact_suffix:
        description: 'Optional suffix for artifact names (for test builds)'
        required: false
        type: string
        default: ''

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - name: linux
          os: ubuntu-latest
        - name: windows
          os: windows-latest
        - name: macos
          os: macos-latest
    env:
      YANTA_VERSION: ${{ inputs.version }}
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Display build info
      run: |
        echo "Building version: ${{ inputs.version }}"
        echo "Commit: ${GITHUB_SHA::7}"

    - name: Install Linux dependencies
      if: matrix.name == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          build-essential \
          pkg-config \
          libayatana-appindicator3-dev \
          libx11-dev \
          xvfb

    - name: Install Windows dependencies
      if: matrix.name == 'windows'
      shell: powershell
      run: |
        choco install -y nsis
        $nsisPath = "${env:ProgramFiles(x86)}\NSIS"
        if (Test-Path $nsisPath) {
          "$nsisPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "$nsisPath\Bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true
        cache-dependency-path: go.sum

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: "npm"
        cache-dependency-path: frontend/package-lock.json

    - name: Install Task CLI
      run: go install github.com/go-task/task/v3/cmd/task@latest

    - name: Install Wails v3
      run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

    - name: Build Linux artifacts
      if: matrix.name == 'linux'
      run: |
        task release:linux
        task release:ubuntu
        task release:list

    - name: Build Windows artifacts
      if: matrix.name == 'windows'
      run: |
        task release:windows
        task release:list

    - name: Build macOS artifacts
      if: matrix.name == 'macos'
      run: |
        task release:macos
        task release:list

    - name: Upload Linux tarball
      if: matrix.name == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: linux-tarball${{ inputs.artifact_suffix }}
        path: build/dist/yanta-linux.tar.gz
        if-no-files-found: error

    - name: Upload Arch Linux package
      if: matrix.name == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: linux-arch${{ inputs.artifact_suffix }}
        path: build/dist/yanta-*-x86_64.pkg.tar.zst
        if-no-files-found: error

    - name: Upload Debian package
      if: matrix.name == 'linux'
      uses: actions/upload-artifact@v4
      with:
        name: linux-deb${{ inputs.artifact_suffix }}
        path: build/dist/yanta_*_amd64.deb
        if-no-files-found: error

    - name: Upload Windows portable
      if: matrix.name == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable${{ inputs.artifact_suffix }}
        path: build/dist/yanta-windows-portable.exe
        if-no-files-found: error

    - name: Upload Windows installer
      if: matrix.name == 'windows'
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer${{ inputs.artifact_suffix }}
        path: build/dist/yanta-windows-installer.exe
        if-no-files-found: error

    - name: Upload macOS app
      if: matrix.name == 'macos'
      uses: actions/upload-artifact@v4
      with:
        name: macos-app${{ inputs.artifact_suffix }}
        path: build/dist/yanta-macos.tar.gz
        if-no-files-found: error
