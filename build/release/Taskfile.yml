version: '3'

# Release artifact generation for all platforms
# Centralizes all release logic in one place

includes:
  common: ../common/Taskfile.yml
  platform: ../platform/Taskfile.yml

vars:
  DIST_DIR: '{{.DIST_DIR | default "build/dist"}}'
  APP_NAME: '{{.APP_NAME | default "yanta"}}'
  BIN_DIR: 'build/bin'

tasks:
  # ============================================================================
  # Linux Releases
  # ============================================================================

  linux:
    summary: Build all Linux release artifacts (tarball + Arch package)
    deps:
      - platform:verify:linux
    cmds:
      - task: common:log:section
        vars:
          MSG: "Building Linux Release Artifacts"
      - task: linux:build
      - task: linux:package:tarball
      - task: linux:package:archlinux
      - task: linux:verify
      - task: common:log:success
        vars:
          MSG: "Linux artifacts ready under {{.DIST_DIR}}"

  linux:build:
    summary: Build Linux binary (internal)
    internal: true
    env:
      TARGET: ubuntu
      PRODUCTION: "true"
    cmds:
      - cd {{.ROOT_DIR}} && task build

  linux:package:tarball:
    summary: Create Linux tarball (internal)
    internal: true
    cmds:
      - |
        set -euo pipefail
        mkdir -p {{.DIST_DIR}}
        tar -C {{.BIN_DIR}} -czf "{{.DIST_DIR}}/yanta-linux.tar.gz" {{.APP_NAME}}
        echo "✓ Linux tarball created: yanta-linux.tar.gz"

  linux:package:archlinux:
    summary: Generate Arch Linux package using nfpm (internal)
    internal: true
    deps:
      - common:ensure:wails
    cmds:
      - |
        set -euo pipefail
        cd {{.ROOT_DIR}}

        # Get version
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        if [[ -n "${YANTA_VERSION:-}" ]]; then
          VERSION="${YANTA_VERSION}"
        elif VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
          VERSION="${VERSION_TAG#v}"
        else
          VERSION="dev-${COMMIT}"
        fi

        export YANTA_VERSION="$VERSION"
        export GOARCH="amd64"

        mkdir -p {{.DIST_DIR}}

        echo "Generating Arch Linux package (version: $VERSION)..."
        wails3 tool package \
          -config ./build/linux/nfpm/nfpm.yaml \
          -format archlinux \
          -name yanta \
          -out {{.DIST_DIR}}

        # Rename to versioned filename
        mv {{.DIST_DIR}}/yanta.pkg.tar.zst {{.DIST_DIR}}/yanta-${VERSION}-1-x86_64.pkg.tar.zst

        echo "✓ Arch package: yanta-${VERSION}-1-x86_64.pkg.tar.zst"

  linux:verify:
    summary: Verify Linux artifacts exist
    internal: true
    cmds:
      - task: common:file:verify-dir
        vars:
          DIR: '{{.DIST_DIR}}'
          MSG: "Distribution directory not found"
      - |
        set -euo pipefail

        # Get version
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        if [[ -n "${YANTA_VERSION:-}" ]]; then
          VERSION="${YANTA_VERSION}"
        elif VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
          VERSION="${VERSION_TAG#v}"
        else
          VERSION="dev-${COMMIT}"
        fi

        ARCH_PKG="{{.DIST_DIR}}/yanta-${VERSION}-1-x86_64.pkg.tar.zst"

        if [ ! -f "$ARCH_PKG" ]; then
          echo "ERROR: Arch package not found: $ARCH_PKG" >&2
          exit 1
        fi

        echo "✓ Arch package verified: $(basename $ARCH_PKG)"

  # ============================================================================
  # Ubuntu/Debian Release
  # ============================================================================

  ubuntu:
    summary: Build Ubuntu/Debian .deb package
    deps:
      - platform:verify:linux
    cmds:
      - task: common:log:section
        vars:
          MSG: "Building Debian Package"
      - task: ubuntu:build
      - task: ubuntu:package
      - task: ubuntu:verify
      - task: common:log:success
        vars:
          MSG: "Debian package created successfully"

  ubuntu:build:
    summary: Build Ubuntu binary (internal)
    internal: true
    env:
      TARGET: ubuntu
      PRODUCTION: "true"
    cmds:
      - cd {{.ROOT_DIR}} && task build

  ubuntu:package:
    summary: Generate Debian package using nfpm (internal)
    internal: true
    deps:
      - common:ensure:wails
    cmds:
      - |
        set -euo pipefail
        cd {{.ROOT_DIR}}

        # Get version
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        if [[ -n "${YANTA_VERSION:-}" ]]; then
          VERSION="${YANTA_VERSION}"
        elif VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
          VERSION="${VERSION_TAG#v}"
        else
          VERSION="dev-${COMMIT}"
        fi

        export YANTA_VERSION="$VERSION"
        export GOARCH="amd64"

        mkdir -p {{.DIST_DIR}}

        echo "Generating Debian package (version: $VERSION)..."
        wails3 tool package \
          -config ./build/linux/nfpm/nfpm.yaml \
          -format deb \
          -name yanta \
          -out {{.DIST_DIR}}

        # Rename to versioned filename
        mv {{.DIST_DIR}}/yanta.deb {{.DIST_DIR}}/yanta_${VERSION}_amd64.deb

        echo "✓ Debian package: yanta_${VERSION}_amd64.deb"

  ubuntu:verify:
    summary: Verify Debian package exists
    internal: true
    cmds:
      - |
        set -euo pipefail

        # Get version
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        if [[ -n "${YANTA_VERSION:-}" ]]; then
          VERSION="${YANTA_VERSION}"
        elif VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
          VERSION="${VERSION_TAG#v}"
        else
          VERSION="dev-${COMMIT}"
        fi

        DEB_FILE="{{.DIST_DIR}}/yanta_${VERSION}_amd64.deb"

        if [ ! -f "$DEB_FILE" ]; then
          echo "ERROR: Expected Debian package not found: $DEB_FILE" >&2
          exit 1
        fi

        echo "✓ Debian package verified: $DEB_FILE"

  # ============================================================================
  # Windows Release
  # ============================================================================

  windows:
    summary: Build Windows release artifacts (portable + installer)
    deps:
      - platform:verify:windows
    cmds:
      - task: common:log:section
        vars:
          MSG: "Building Windows Release Artifacts"
      - task: windows:build
      - task: windows:package
      - task: windows:verify
      - task: common:log:success
        vars:
          MSG: "Windows artifacts ready under {{.DIST_DIR}}"

  windows:build:
    summary: Build Windows binary (internal)
    internal: true
    env:
      TARGET: win
      PRODUCTION: "true"
    cmds:
      - cd {{.ROOT_DIR}} && task build

  windows:package:
    summary: Package Windows artifacts (internal)
    internal: true
    cmds:
      - task: common:dir:clean
        vars:
          DIR: '{{.DIST_DIR}}'
      - |
        set -euo pipefail

        # Copy portable exe
        PORTABLE="{{.BIN_DIR}}/{{.APP_NAME}}.exe"
        if [ ! -f "$PORTABLE" ]; then
          echo "ERROR: Portable binary not found at $PORTABLE" >&2
          exit 1
        fi
        cp "$PORTABLE" "{{.DIST_DIR}}/yanta-windows-portable.exe"
        echo "✓ Copied portable exe"

        # Find and copy installer
        echo "Looking for installer in {{.BIN_DIR}}..."
        INSTALLER=$(ls {{.BIN_DIR}}/*installer*.exe 2>/dev/null | head -1 || true)
        if [ -z "$INSTALLER" ]; then
          echo "ERROR: Could not locate NSIS installer output in {{.BIN_DIR}}" >&2
          ls -la {{.BIN_DIR}}/ || true
          exit 1
        fi
        cp "$INSTALLER" "{{.DIST_DIR}}/yanta-windows-installer.exe"
        echo "✓ Copied installer exe"

  windows:verify:
    summary: Verify Windows artifacts exist
    internal: true
    cmds:
      - task: common:file:verify
        vars:
          FILE: '{{.DIST_DIR}}/yanta-windows-portable.exe'
          MSG: "Windows portable exe not found"
      - task: common:file:verify
        vars:
          FILE: '{{.DIST_DIR}}/yanta-windows-installer.exe'
          MSG: "Windows installer exe not found"

  # ============================================================================
  # macOS Release
  # ============================================================================

  macos:
    summary: Build macOS release tarball
    deps:
      - platform:verify:macos
    cmds:
      - task: common:log:section
        vars:
          MSG: "Building macOS Release Artifacts"
      - task: macos:build
      - task: macos:package
      - task: macos:verify
      - task: common:log:success
        vars:
          MSG: "macOS artifacts ready under {{.DIST_DIR}}"

  macos:build:
    summary: Build macOS binary (internal)
    internal: true
    env:
      TARGET: osx
      PRODUCTION: "true"
    cmds:
      - cd {{.ROOT_DIR}} && task build

  macos:package:
    summary: Package macOS app into tarball (internal)
    internal: true
    cmds:
      - task: common:dir:clean
        vars:
          DIR: '{{.DIST_DIR}}'
      - |
        set -euo pipefail

        if [ ! -d "{{.BIN_DIR}}/yanta.app" ]; then
          echo "ERROR: yanta.app not found in {{.BIN_DIR}}" >&2
          ls -la {{.BIN_DIR}}/ || true
          exit 1
        fi

        tar -C {{.BIN_DIR}} -czf "{{.DIST_DIR}}/yanta-macos.tar.gz" yanta.app
        echo "✓ Created macOS tarball"

  macos:verify:
    summary: Verify macOS artifacts exist
    internal: true
    cmds:
      - task: common:file:verify
        vars:
          FILE: '{{.DIST_DIR}}/yanta-macos.tar.gz'
          MSG: "macOS tarball not found"

  # ============================================================================
  # Platform-aware "all" releases
  # ============================================================================

  all:
    summary: Build all release artifacts supported on current host
    cmds:
      - task: all:detect

  all:detect:
    summary: Detect platform and build appropriate releases
    internal: true
    cmds:
      - |
        PLATFORM=$(task common:platform:detect)

        case "$PLATFORM" in
          linux)
            echo "Detected Linux - building Linux + Ubuntu releases"
            task release:all:linux
            ;;
          darwin)
            echo "Detected macOS - building macOS release"
            task release:all:macos
            ;;
          windows)
            echo "Detected Windows - building Windows release"
            task release:all:windows
            ;;
          *)
            echo "Unknown platform: $PLATFORM" >&2
            exit 1
            ;;
        esac

  all:linux:
    summary: Build all Linux releases (Linux + Ubuntu)
    platforms: [linux]
    cmds:
      - task: linux
      - task: ubuntu

  all:windows:
    summary: Build all Windows releases
    platforms: [windows]
    cmds:
      - task: windows

  all:macos:
    summary: Build all macOS releases
    platforms: [darwin]
    cmds:
      - task: macos

  # ============================================================================
  # Release verification and listing
  # ============================================================================

  list:
    summary: List all generated release artifacts
    cmds:
      - |
        echo "Release artifacts in {{.DIST_DIR}}:"
        echo ""
        if [ -d "{{.DIST_DIR}}" ]; then
          ls -lh {{.DIST_DIR}}/ 2>/dev/null || echo "No artifacts found"
        else
          echo "Distribution directory does not exist"
        fi

  verify:
    summary: Verify all expected artifacts for current platform exist
    cmds:
      - |
        PLATFORM=$(task common:platform:detect)

        case "$PLATFORM" in
          linux)
            task release:linux:verify
            task release:ubuntu:verify
            ;;
          darwin)
            task release:macos:verify
            ;;
          windows)
            task release:windows:verify
            ;;
        esac

  # ============================================================================
  # Clean release artifacts
  # ============================================================================

  clean:
    summary: Clean all release artifacts
    cmds:
      - task: common:dir:clean
        vars:
          DIR: '{{.DIST_DIR}}'
      - task: common:log:success
        vars:
          MSG: "Release artifacts cleaned"
