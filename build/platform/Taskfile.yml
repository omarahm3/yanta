version: '3'

# Platform-specific build configurations
# Defines platform-specific variables and build settings
# Cross-platform: Uses Taskfile {{OS}} conditionals instead of bash-only constructs

includes:
  common: ../common/Taskfile.yml

tasks:
  # ============================================================================
  # Platform Configuration Getters
  # Cross-platform JSON output using echo commands
  # ============================================================================

  config:linux:ubuntu:
    summary: Get build config for Ubuntu/Debian Linux
    desc: |
      Cross-platform: Uses Taskfile {{OS}} conditional
      - On Linux: Outputs JSON config for Ubuntu build
      - On Windows: Also outputs (for CI pipeline parsing)
    internal: true
    silent: true
    cmds:
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command "Write-Output '{ \"goos\": \"linux\", \"goarch\": \"amd64\", \"use_webkit41\": true, \"output_suffix\": \"\", \"requires_host\": \"linux\", \"cc\": \"\", \"cxx\": \"\" }'"
        {{else}}
        echo '{ "goos": "linux", "goarch": "amd64", "use_webkit41": true, "output_suffix": "", "requires_host": "linux", "cc": "", "cxx": "" }'
        {{end}}

  config:linux:arch:
    summary: Get build config for Arch Linux (includes artifact generation)
    desc: |
      Cross-platform: Uses Taskfile {{OS}} conditional
      - On Linux: Outputs JSON config for Arch build with post_build step
      - On Windows: Also outputs (for CI pipeline parsing)
    internal: true
    silent: true
    cmds:
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command "Write-Output '{ \"goos\": \"linux\", \"goarch\": \"amd64\", \"use_webkit41\": true, \"output_suffix\": \"\", \"requires_host\": \"linux\", \"post_build\": \"arch\", \"cc\": \"\", \"cxx\": \"\" }'"
        {{else}}
        echo '{ "goos": "linux", "goarch": "amd64", "use_webkit41": true, "output_suffix": "", "requires_host": "linux", "post_build": "arch", "cc": "", "cxx": "" }'
        {{end}}

  config:windows:
    summary: Get build config for Windows
    desc: |
      Cross-platform: Uses Taskfile {{OS}} built-in instead of uname
      - On Windows: Native build (no cross-compiler needed)
      - On Linux: Cross-compile using MinGW
    internal: true
    silent: true
    cmds:
      # Cross-platform platform detection using Taskfile {{OS}} built-in
      - |
        {{if eq OS "linux"}}
        echo '{ "goos": "windows", "goarch": "amd64", "use_webkit41": false, "output_suffix": ".exe", "requires_host": "linux-mingw", "cc": "x86_64-w64-mingw32-gcc", "cxx": "x86_64-w64-mingw32-g++" }'
        {{else if eq OS "windows"}}
        powershell -NoProfile -Command "Write-Output '{ \"goos\": \"\", \"goarch\": \"amd64\", \"use_webkit41\": false, \"output_suffix\": \".exe\", \"requires_host\": \"windows\", \"cc\": \"\", \"cxx\": \"\" }'"
        {{else}}
        echo "Error: Windows builds must run on Windows or Linux (with MinGW)" >&2
        exit 1
        {{end}}

  config:macos:
    summary: Get build config for macOS
    desc: |
      Cross-platform: Uses Taskfile {{OS}} conditional
      - On macOS: Outputs JSON config for Darwin build
      - On other platforms: Also outputs (for CI pipeline parsing)
    internal: true
    silent: true
    cmds:
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command "Write-Output '{ \"goos\": \"darwin\", \"goarch\": \"amd64\", \"use_webkit41\": false, \"output_suffix\": \"\", \"requires_host\": \"darwin\", \"cc\": \"\", \"cxx\": \"\" }'"
        {{else}}
        echo '{ "goos": "darwin", "goarch": "amd64", "use_webkit41": false, "output_suffix": "", "requires_host": "darwin", "cc": "", "cxx": "" }'
        {{end}}

  # ============================================================================
  # Platform Verification
  # ============================================================================

  verify:linux:
    summary: Verify we're on Linux (for Linux builds)
    internal: true
    cmds:
      - task: common:platform:verify
        vars:
          REQUIRED: linux

  verify:macos:
    summary: Verify we're on macOS (for macOS builds)
    internal: true
    cmds:
      - task: common:platform:verify
        vars:
          REQUIRED: darwin

  verify:windows:
    summary: Verify we're on Windows or have MinGW (for Windows builds)
    desc: |
      Cross-platform: Uses Taskfile {{OS}} built-in instead of uname
      - On Windows: Always passes (native build)
      - On Linux: Checks for MinGW cross-compiler
      - On other platforms: Fails with error message
    internal: true
    cmds:
      # Cross-platform platform detection using Taskfile {{OS}} built-in
      - |
        {{if eq OS "linux"}}
        if ! which x86_64-w64-mingw32-gcc >/dev/null 2>&1; then
          echo "Windows cross-compilation on Linux requires MinGW (x86_64-w64-mingw32-gcc)" >&2
          echo "Install: sudo apt-get install -y mingw-w64" >&2
          exit 1
        fi
        {{else if eq OS "windows"}}
        powershell -NoProfile -Command "Write-Output 'Native Windows build - no verification needed'"
        {{else}}
        echo "Windows builds must run on Windows or Linux (with MinGW)" >&2
        exit 1
        {{end}}

  # ============================================================================
  # MinGW Setup (for cross-compiling Windows on Linux)
  # ============================================================================

  ensure:mingw:
    summary: Ensure MinGW is installed (for Windows cross-compile on Linux)
    desc: |
      Cross-platform: Uses Taskfile {{OS}} built-in
      - On Linux: Checks for MinGW and installs via apt-get if missing
      - On Windows: Not needed (native build)
      - Uses 'which' instead of 'command -v' for better portability
    internal: true
    cmds:
      # MinGW is only needed on Linux for cross-compilation
      - |
        {{if eq OS "linux"}}
        if which x86_64-w64-mingw32-gcc >/dev/null 2>&1 && which x86_64-w64-mingw32-g++ >/dev/null 2>&1; then
          echo "MinGW already installed"
          exit 0
        fi

        if which apt-get >/dev/null 2>&1; then
          echo "Installing MinGW toolchain (mingw-w64)..."
          sudo apt-get update
          sudo apt-get install -y mingw-w64
        else
          echo "MinGW toolchain not found and apt-get not available" >&2
          echo "Please install MinGW manually: x86_64-w64-mingw32-gcc, x86_64-w64-mingw32-g++" >&2
          exit 1
        fi
        {{else if eq OS "windows"}}
        powershell -NoProfile -Command "Write-Output 'MinGW not needed on Windows (native build)'"
        {{else}}
        echo "MinGW cross-compilation is only supported on Linux" >&2
        exit 1
        {{end}}

  # ============================================================================
  # Build Tag Generation
  # ============================================================================

  build-tags:linux:
    summary: Get build tags for Linux
    internal: true
    silent: true
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''-tags webkit2_41''"{{else}}echo "-tags webkit2_41"{{end}}'

  build-tags:windows:
    summary: Get build tags for Windows
    internal: true
    silent: true
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''''"{{else}}echo ""{{end}}'

  build-tags:macos:
    summary: Get build tags for macOS
    internal: true
    silent: true
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''''"{{else}}echo ""{{end}}'

  # ============================================================================
  # Platform-specific Artifact Names
  # ============================================================================

  artifact-name:linux:tarball:
    summary: Get Linux tarball artifact name
    internal: true
    silent: true
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''yanta-linux.tar.gz''"{{else}}echo "yanta-linux.tar.gz"{{end}}'

  artifact-name:linux:arch:
    summary: Get Arch Linux package artifact name pattern
    internal: true
    silent: true
    vars:
      VERSION: '{{.VERSION | default "UNKNOWN"}}'
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''yanta-{{.VERSION}}-1-x86_64.pkg.tar.gz''"{{else}}echo "yanta-{{.VERSION}}-1-x86_64.pkg.tar.gz"{{end}}'

  artifact-name:linux:deb:
    summary: Get Debian package artifact name
    internal: true
    silent: true
    vars:
      VERSION: '{{.VERSION | default "UNKNOWN"}}'
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''yanta_{{.VERSION}}_amd64.deb''"{{else}}echo "yanta_{{.VERSION}}_amd64.deb"{{end}}'

  artifact-name:windows:portable:
    summary: Get Windows portable exe artifact name
    internal: true
    silent: true
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''yanta-windows-portable.exe''"{{else}}echo "yanta-windows-portable.exe"{{end}}'

  artifact-name:windows:installer:
    summary: Get Windows installer artifact name
    internal: true
    silent: true
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''yanta-windows-installer.exe''"{{else}}echo "yanta-windows-installer.exe"{{end}}'

  artifact-name:macos:tarball:
    summary: Get macOS tarball artifact name
    internal: true
    silent: true
    cmds:
      - '{{if eq OS "windows"}}powershell -NoProfile -Command "Write-Output ''yanta-macos.tar.gz''"{{else}}echo "yanta-macos.tar.gz"{{end}}'
