version: '3'

# Platform-specific build configurations
# Defines platform-specific variables and build settings

includes:
  common: ../common/Taskfile.yml

tasks:
  # ============================================================================
  # Platform Configuration Getters
  # ============================================================================

  config:linux:ubuntu:
    summary: Get build config for Ubuntu/Debian Linux
    internal: true
    silent: true
    cmds:
      - |
        cat <<'EOF'
        {
          "goos": "linux",
          "goarch": "amd64",
          "use_webkit41": true,
          "output_suffix": "",
          "requires_host": "linux",
          "cc": "",
          "cxx": ""
        }
        EOF

  config:linux:arch:
    summary: Get build config for Arch Linux (includes artifact generation)
    internal: true
    silent: true
    cmds:
      - |
        cat <<'EOF'
        {
          "goos": "linux",
          "goarch": "amd64",
          "use_webkit41": true,
          "output_suffix": "",
          "requires_host": "linux",
          "post_build": "arch",
          "cc": "",
          "cxx": ""
        }
        EOF

  config:windows:
    summary: Get build config for Windows
    desc: |
      Cross-platform: Uses Taskfile {{OS}} built-in instead of uname
      - On Windows: Native build (no cross-compiler needed)
      - On Linux: Cross-compile using MinGW
    internal: true
    silent: true
    cmds:
      # Cross-platform platform detection using Taskfile {{OS}} built-in
      - |
        {{if eq OS "linux"}}
        cat <<'EOF'
        {
          "goos": "windows",
          "goarch": "amd64",
          "use_webkit41": false,
          "output_suffix": ".exe",
          "requires_host": "linux-mingw",
          "cc": "x86_64-w64-mingw32-gcc",
          "cxx": "x86_64-w64-mingw32-g++"
        }
        EOF
        {{else if eq OS "windows"}}
        echo {
        echo   "goos": "",
        echo   "goarch": "amd64",
        echo   "use_webkit41": false,
        echo   "output_suffix": ".exe",
        echo   "requires_host": "windows",
        echo   "cc": "",
        echo   "cxx": ""
        echo }
        {{else}}
        echo "Error: Windows builds must run on Windows or Linux (with MinGW)" >&2
        exit 1
        {{end}}

  config:macos:
    summary: Get build config for macOS
    internal: true
    silent: true
    cmds:
      - |
        cat <<'EOF'
        {
          "goos": "darwin",
          "goarch": "amd64",
          "use_webkit41": false,
          "output_suffix": "",
          "requires_host": "darwin",
          "cc": "",
          "cxx": ""
        }
        EOF

  # ============================================================================
  # Platform Verification
  # ============================================================================

  verify:linux:
    summary: Verify we're on Linux (for Linux builds)
    internal: true
    cmds:
      - task: common:platform:verify
        vars:
          REQUIRED: linux

  verify:macos:
    summary: Verify we're on macOS (for macOS builds)
    internal: true
    cmds:
      - task: common:platform:verify
        vars:
          REQUIRED: darwin

  verify:windows:
    summary: Verify we're on Windows or have MinGW (for Windows builds)
    desc: |
      Cross-platform: Uses Taskfile {{OS}} built-in instead of uname
      - On Windows: Always passes (native build)
      - On Linux: Checks for MinGW cross-compiler
      - On other platforms: Fails with error message
    internal: true
    cmds:
      # Cross-platform platform detection using Taskfile {{OS}} built-in
      - |
        {{if eq OS "linux"}}
        # Check for MinGW on Linux using 'which' (more portable than 'command -v')
        if ! which x86_64-w64-mingw32-gcc >/dev/null 2>&1; then
          echo "Windows cross-compilation on Linux requires MinGW (x86_64-w64-mingw32-gcc)" >&2
          echo "Install: sudo apt-get install -y mingw-w64" >&2
          exit 1
        fi
        {{else if eq OS "windows"}}
        REM Native Windows build - no verification needed
        {{else}}
        echo "Windows builds must run on Windows or Linux (with MinGW)" >&2
        exit 1
        {{end}}

  # ============================================================================
  # MinGW Setup (for cross-compiling Windows on Linux)
  # ============================================================================

  ensure:mingw:
    summary: Ensure MinGW is installed (for Windows cross-compile on Linux)
    desc: |
      Cross-platform: Uses Taskfile {{OS}} built-in
      - On Linux: Checks for MinGW and installs via apt-get if missing
      - On Windows: Not needed (native build)
      - Uses 'which' instead of 'command -v' for better portability
    internal: true
    cmds:
      # MinGW is only needed on Linux for cross-compilation
      - |
        {{if eq OS "linux"}}
        # Use 'which' instead of 'command -v' for better portability
        if which x86_64-w64-mingw32-gcc >/dev/null 2>&1 && which x86_64-w64-mingw32-g++ >/dev/null 2>&1; then
          echo "MinGW already installed"
          exit 0
        fi

        if which apt-get >/dev/null 2>&1; then
          echo "Installing MinGW toolchain (mingw-w64)..."
          sudo apt-get update
          sudo apt-get install -y mingw-w64
        else
          echo "MinGW toolchain not found and apt-get not available" >&2
          echo "Please install MinGW manually: x86_64-w64-mingw32-gcc, x86_64-w64-mingw32-g++" >&2
          exit 1
        fi
        {{else if eq OS "windows"}}
        echo "MinGW not needed on Windows (native build)"
        {{else}}
        echo "MinGW cross-compilation is only supported on Linux" >&2
        exit 1
        {{end}}

  # ============================================================================
  # Build Tag Generation
  # ============================================================================

  build-tags:linux:
    summary: Get build tags for Linux
    internal: true
    silent: true
    cmds:
      - echo "-tags webkit2_41"

  build-tags:windows:
    summary: Get build tags for Windows
    internal: true
    silent: true
    cmds:
      - echo ""

  build-tags:macos:
    summary: Get build tags for macOS
    internal: true
    silent: true
    cmds:
      - echo ""

  # ============================================================================
  # Platform-specific Artifact Names
  # ============================================================================

  artifact-name:linux:tarball:
    summary: Get Linux tarball artifact name
    internal: true
    silent: true
    cmds:
      - echo "yanta-linux.tar.gz"

  artifact-name:linux:arch:
    summary: Get Arch Linux package artifact name pattern
    internal: true
    silent: true
    vars:
      VERSION: '{{.VERSION | default "UNKNOWN"}}'
    cmds:
      - echo "yanta-{{.VERSION}}-1-x86_64.pkg.tar.gz"

  artifact-name:linux:deb:
    summary: Get Debian package artifact name
    internal: true
    silent: true
    vars:
      VERSION: '{{.VERSION | default "UNKNOWN"}}'
    cmds:
      - echo "yanta_{{.VERSION}}_amd64.deb"

  artifact-name:windows:portable:
    summary: Get Windows portable exe artifact name
    internal: true
    silent: true
    cmds:
      - echo "yanta-windows-portable.exe"

  artifact-name:windows:installer:
    summary: Get Windows installer artifact name
    internal: true
    silent: true
    cmds:
      - echo "yanta-windows-installer.exe"

  artifact-name:macos:tarball:
    summary: Get macOS tarball artifact name
    internal: true
    silent: true
    cmds:
      - echo "yanta-macos.tar.gz"
