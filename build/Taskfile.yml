version: "3"

# Core build tasks - frontend, backend, and Go compilation
# Uses common utilities for DRY principles

includes:
  common: ./common/Taskfile.yml
  platform: ./platform/Taskfile.yml

vars:
  APP_NAME: '{{.APP_NAME | default "yanta"}}'
  BIN_DIR: "build/bin"

tasks:
  # ============================================================================
  # Wails & Bindings
  # ============================================================================

  ensure:wails:
    summary: Ensure wails3 CLI is installed
    silent: true
    cmds:
      - task: common:ensure:wails

  generate:icons:
    label: "generate:icons"
    summary: Generate platform-specific icons from appicon.png
    deps:
      - ensure:wails
    sources:
      - "./appicon.png"
    generates:
      - "./icons.icns"
      - "./icon.ico"
      - "./windows/icon.ico"
      - "./darwin/icons.icns"
    cmds:
      - |
        set -euo pipefail
        cd build

        echo "Generating icons from appicon.png..."
        wails3 generate icons -input ./appicon.png

        # Move/copy icons to platform-specific directories
        mkdir -p windows darwin
        cp icon.ico windows/
        cp icons.icns darwin/

        echo "✓ Icons generated: icons.icns, icon.ico"
        echo "✓ Platform icons: windows/icon.ico, darwin/icons.icns"

  generate:syso:
    label: "generate:syso"
    summary: Generate Windows resource file (.syso) with embedded icon
    deps:
      - common:ensure:go
    sources:
      - "./windows/icon.ico"
    generates:
      - "../rsrc_windows_windows_amd64.syso"
    cmds:
      - |
        set -euo pipefail

        # Ensure go-winres is installed
        if ! command -v go-winres >/dev/null 2>&1; then
          echo "Installing go-winres..."
          go install github.com/tc-hib/go-winres@latest
        fi

        # Get version
        if [[ -n "${YANTA_VERSION:-}" ]]; then
          VERSION="${YANTA_VERSION}"
        elif VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
          VERSION="${VERSION_TAG#v}"
        else
          VERSION="1.0.0"
        fi

        echo "Generating Windows resources (version: $VERSION)..."

        # Generate .syso file with embedded icon using go-winres simply
        go-winres simply \
          --icon build/windows/icon.ico \
          --out rsrc_windows \
          --arch amd64 \
          --manifest gui \
          --product-name "YANTA" \
          --file-description "YANTA - Yet Another Note Taking App" \
          --copyright "Copyright (c) 2024-2025 Omar Ahmed" \
          --original-filename "yanta.exe" \
          --product-version "$VERSION" \
          --file-version "$VERSION"

        echo "✓ Windows resources generated: rsrc_windows_windows_amd64.syso"

  generate:bindings:
    label: "generate:bindings"
    summary: Generate TypeScript bindings from Go services
    silent: true
    deps:
      - ensure:wails
    sources:
      - "../**/*.go"
      - "../go.mod"
      - "../go.sum"
      - exclude: "../frontend/**/*"
    generates:
      - "../frontend/bindings/**/*"
    cmds:
      - |
        if [ "${SKIP_WAILS_BINDINGS:-0}" = "1" ]; then
          echo "Skipping binding generation (SKIP_WAILS_BINDINGS=1)"
          exit 0
        fi

        GO_CACHE_DIR="${GO_CACHE_DIR:-.gocache}"
        case "$GO_CACHE_DIR" in
          /*) ;;
          *) GO_CACHE_DIR="$(pwd)/$GO_CACHE_DIR" ;;
        esac
        mkdir -p "$GO_CACHE_DIR"
        GOCACHE="$GO_CACHE_DIR" GOFLAGS="" wails3 generate bindings -clean=true -ts

  # ============================================================================
  # Frontend Tasks
  # ============================================================================

  dev:frontend:
    summary: Run frontend dev server (Vite)
    silent: true
    dir: "{{.ROOT_DIR}}/frontend"
    deps:
      - common:ensure:npm
    env:
      WAILS_VITE_PORT: '{{.WAILS_VITE_PORT | default "34115"}}'
    cmds:
      - npm run dev

  # ============================================================================
  # Go Build (Core Build Logic)
  # ============================================================================

  go:build:
    summary: Build Go binary for specified target platform
    internal: true
    silent: true
    deps:
      - common:ensure:go
      - common:ensure:npm
    vars:
      TARGET: '{{.TARGET | default "local"}}'
      DEBUG: '{{.DEBUG | default "0"}}'
    cmds:
      - |
        set -euo pipefail

        # Setup Go cache
        GO_CACHE_DIR="${GO_CACHE_DIR:-.gocache}"
        case "$GO_CACHE_DIR" in
          /*) ;;
          *) GO_CACHE_DIR="$(pwd)/$GO_CACHE_DIR" ;;
        esac
        mkdir -p "$GO_CACHE_DIR"
        export GOCACHE="$GO_CACHE_DIR"

        TARGET="{{.TARGET}}"
        DEBUG="{{.DEBUG}}"
        HOST_UNAME=$(uname -s | tr '[:upper:]' '[:lower:]')

        # Auto-detect target if "local"
        if [[ -z "$TARGET" || "$TARGET" == "local" ]]; then
          case "$HOST_UNAME" in
            linux) TARGET="ubuntu" ;;
            darwin) TARGET="osx" ;;
            *mingw*|*msys*|*cygwin*|windows) TARGET="win" ;;
            *) TARGET="ubuntu" ;;
          esac
        fi

        # Platform-specific configuration
        USE_WEBKIT41=false
        GOOS_TARGET=""
        GOARCH_TARGET="amd64"
        CC_OVERRIDE=""
        CXX_OVERRIDE=""
        OUTPUT_SUFFIX=""

        case "$TARGET" in
          win|windows)
            GOOS_TARGET="windows"
            OUTPUT_SUFFIX=".exe"

            # Generate Windows resources (.syso) for icon embedding
            echo "Generating Windows resources..."
            if ! command -v go-winres >/dev/null 2>&1; then
              echo "Installing go-winres..."
              go install github.com/tc-hib/go-winres@latest
            fi

            # Get version for Windows resources
            WINRES_VERSION="1.0.0"
            if [[ -n "${YANTA_VERSION:-}" ]]; then
              WINRES_VERSION="${YANTA_VERSION}"
            elif WINRES_VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
              WINRES_VERSION="${WINRES_VERSION_TAG#v}"
            fi

            # Generate .syso file with embedded icon using go-winres simply
            go-winres simply \
              --icon build/windows/icon.ico \
              --out rsrc_windows \
              --arch amd64 \
              --manifest gui \
              --product-name "YANTA" \
              --file-description "YANTA - Yet Another Note Taking App" \
              --copyright "Copyright (c) 2024-2025 Omar Ahmed" \
              --original-filename "yanta.exe" \
              --product-version "$WINRES_VERSION" \
              --file-version "$WINRES_VERSION"

            echo "✓ Windows resources generated (rsrc_windows_windows_amd64.syso)"

            if [[ "$HOST_UNAME" == "linux" ]]; then
              echo "Building Windows target on Linux (MinGW cross-compile)..."
              # Ensure MinGW is available
              if ! command -v x86_64-w64-mingw32-gcc >/dev/null 2>&1; then
                echo "ERROR: MinGW not found. Install: sudo apt-get install -y mingw-w64" >&2
                exit 1
              fi
              CC_OVERRIDE="x86_64-w64-mingw32-gcc"
              CXX_OVERRIDE="x86_64-w64-mingw32-g++"
            elif [[ "$HOST_UNAME" == *mingw* || "$HOST_UNAME" == *msys* || "$HOST_UNAME" == *cygwin* || "$HOST_UNAME" == *windows* ]]; then
              GOOS_TARGET=""
            else
              echo "ERROR: Windows builds must run on Windows or Linux (with MinGW)" >&2
              exit 1
            fi
            ;;

          ubuntu)
            # Verify we're on Linux
            if [[ "$HOST_UNAME" != "linux" ]]; then
              echo "ERROR: Ubuntu target requires Linux host (current: $HOST_UNAME)" >&2
              exit 1
            fi
            GOOS_TARGET="linux"
            USE_WEBKIT41=true
            ;;

          arch)
            # Verify we're on Linux
            if [[ "$HOST_UNAME" != "linux" ]]; then
              echo "ERROR: Arch target requires Linux host (current: $HOST_UNAME)" >&2
              exit 1
            fi
            GOOS_TARGET="linux"
            USE_WEBKIT41=true
            ;;

          osx|mac|macos)
            # Verify we're on macOS
            if [[ "$HOST_UNAME" != "darwin" ]]; then
              echo "ERROR: macOS target requires macOS host (current: $HOST_UNAME)" >&2
              exit 1
            fi
            GOOS_TARGET="darwin"
            ;;

          *)
            echo "ERROR: Unknown target: $TARGET" >&2
            echo "Valid targets: win, ubuntu, arch, osx" >&2
            exit 1
            ;;
        esac

        # Get version info using common utilities
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        if [[ -n "${YANTA_VERSION:-}" ]]; then
          VERSION="${YANTA_VERSION}"
        elif VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
          VERSION="${VERSION_TAG#v}"
        else
          VERSION="dev-${COMMIT}"
        fi
        DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Build LD flags
        LD_FLAGS="-X yanta/internal/system.BuildVersion=${VERSION}"
        LD_FLAGS="$LD_FLAGS -X yanta/internal/system.BuildCommit=${COMMIT}"
        LD_FLAGS="$LD_FLAGS -X yanta/internal/system.BuildDate=${DATE}"

        if [[ "$TARGET" == "win" || "$TARGET" == "windows" ]]; then
          LD_FLAGS="$LD_FLAGS -H=windowsgui"
        fi

        echo "========================================"
        echo "Building: {{.APP_NAME}}"
        echo "Target:   $TARGET"
        echo "Version:  $VERSION"
        echo "Commit:   $COMMIT"
        echo "========================================"

        # Setup output
        mkdir -p {{.BIN_DIR}}
        OUTPUT_PATH="{{.BIN_DIR}}/{{.APP_NAME}}${OUTPUT_SUFFIX}"

        # Build environment variables
        BUILD_ENV=()
        if [[ -n "$GOOS_TARGET" ]]; then
          BUILD_ENV+=(GOOS="$GOOS_TARGET")
        fi
        BUILD_ENV+=(GOARCH="$GOARCH_TARGET")
        # CGO is REQUIRED for Wails v3 (native platform APIs)
        BUILD_ENV+=(CGO_ENABLED=1)
        if [[ -n "$CC_OVERRIDE" ]]; then
          BUILD_ENV+=(CC="$CC_OVERRIDE" CXX="$CXX_OVERRIDE")
        fi

        # Build tags
        BUILD_TAGS=()
        if $USE_WEBKIT41; then
          BUILD_TAGS+=("-tags" "webkit2_41")
        fi

        # Debug mode
        if [[ "$DEBUG" == "1" ]]; then
          export YANTA_DEBUG_BUILD=1
          echo "Debug mode enabled"
        fi

        # Execute build
        echo "Compiling Go binary..."
        env "${BUILD_ENV[@]}" go build ${BUILD_TAGS[@]+"${BUILD_TAGS[@]}"} -ldflags "$LD_FLAGS" -o "$OUTPUT_PATH" .

        echo "✓ Build complete: $OUTPUT_PATH"

        # Create Windows installer using NSIS (only on Windows host)
        if [[ "$TARGET" == "win" || "$TARGET" == "windows" ]]; then
          if [[ "$HOST_UNAME" == *mingw* || "$HOST_UNAME" == *msys* || "$HOST_UNAME" == *cygwin* || "$HOST_UNAME" == *windows* ]]; then
            if command -v makensis >/dev/null 2>&1; then
              echo "Creating Windows installer..."
              NSI_DIR="build/windows/installer"
              if [[ -f "$NSI_DIR/project.nsi" ]]; then
                # Convert Unix paths to Windows paths for NSIS (a native Windows program)
                # cygpath -w converts /d/path/to/dir to D:\path\to\dir
                ABS_NSI_DIR="$(cygpath -w "$(cd "$NSI_DIR" && pwd)")"
                ABS_BINARY="$(cygpath -w "$(cd "$(dirname "$OUTPUT_PATH")" && pwd)/$(basename "$OUTPUT_PATH")")"
                ABS_NSI_FILE="${ABS_NSI_DIR}\\project.nsi"
                # Run makensis with explicit include directory to ensure wails_tools.nsh is found
                makensis "/X!addincludedir ${ABS_NSI_DIR}" "-DARG_WAILS_AMD64_BINARY=${ABS_BINARY}" "${ABS_NSI_FILE}"
                echo "✓ Windows installer created"
              else
                echo "WARNING: NSIS script not found at $NSI_DIR/project.nsi, skipping installer creation"
              fi
            else
              echo "WARNING: makensis not found, skipping installer creation"
            fi
          else
            echo "Note: Cross-compiling Windows binary from Linux, installer must be created on Windows"
          fi
        fi

        # Create macOS .app bundle
        if [[ "$TARGET" == "osx" || "$TARGET" == "mac" || "$TARGET" == "macos" ]]; then
          echo "Creating macOS .app bundle..."
          APP_DIR="{{.BIN_DIR}}/{{.APP_NAME}}.app"
          CONTENTS_DIR="$APP_DIR/Contents"
          MACOS_DIR="$CONTENTS_DIR/MacOS"
          RESOURCES_DIR="$CONTENTS_DIR/Resources"

          mkdir -p "$MACOS_DIR" "$RESOURCES_DIR"
          cp "$OUTPUT_PATH" "$MACOS_DIR/{{.APP_NAME}}"

          /usr/libexec/PlistBuddy -c "Clear dict" "$CONTENTS_DIR/Info.plist" 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :CFBundlePackageType string APPL" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleName string YANTA" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string YANTA" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string {{.APP_NAME}}" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string com.omarahmed.yanta" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string ${VERSION}" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string ${VERSION}" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleGetInfoString string Yet Another Note Taking App" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleIconFile string iconfile" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :LSMinimumSystemVersion string 10.15" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :NSHighResolutionCapable bool true" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :NSHumanReadableCopyright string Copyright 2024-2025 Omar Ahmed" "$CONTENTS_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :NSSupportsAutomaticGraphicsSwitching bool true" "$CONTENTS_DIR/Info.plist"

          if [[ -f "build/darwin/icons.icns" ]]; then
            cp "build/darwin/icons.icns" "$RESOURCES_DIR/iconfile.icns"
          fi

          codesign --force --deep --sign - "$APP_DIR"
          echo "✓ macOS .app bundle created: $APP_DIR"
        fi

  # ============================================================================
  # Wails Build (alternative build method using wails3)
  # ============================================================================

  wails:build:
    summary: Build using wails3 build command (alternative method)
    deps:
      - ensure:wails
    vars:
      PLATFORM: '{{.PLATFORM | default ""}}'
      EXTRA_FLAGS: '{{.EXTRA_FLAGS | default ""}}'
    cmds:
      - |
        set -euo pipefail
        if [ -n "{{.EXTRA_FLAGS}}" ]; then
          wails3 build {{.EXTRA_FLAGS}}
        else
          wails3 build
        fi
