version: "3"

# Core build tasks - frontend, backend, and Go compilation
# Uses common utilities for DRY principles

includes:
  common: ./common/Taskfile.yml
  platform: ./platform/Taskfile.yml

vars:
  APP_NAME: '{{.APP_NAME | default "yanta"}}'
  BIN_DIR: "build/bin"

tasks:
  # ============================================================================
  # Wails & Bindings
  # ============================================================================

  ensure:wails:
    summary: Ensure wails3 CLI is installed
    silent: true
    cmds:
      - task: common:ensure:wails

  generate:icons:
    label: "generate:icons"
    summary: Generate platform-specific icons from appicon.png (cross-platform)
    deps:
      - ensure:wails
    sources:
      - "./appicon.png"
    generates:
      - "./icons.icns"
      - "./icon.ico"
      - "./windows/icon.ico"
      - "./darwin/icons.icns"
    dir: build
    cmds:
      # Log start message
      - task: common:log:info
        vars:
          MSG: "Generating icons from appicon.png..."
      # Generate icons using wails3 (cross-platform - wails3 works on all platforms)
      - wails3 generate icons -input ./appicon.png
      # Ensure platform-specific directories exist (cross-platform)
      - task: common:dir:ensure
        vars:
          DIR: windows
      - task: common:dir:ensure
        vars:
          DIR: darwin
      # Copy icons to platform-specific directories (cross-platform)
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command "Copy-Item -Path 'icon.ico' -Destination 'windows/' -Force"
        powershell -NoProfile -Command "Copy-Item -Path 'icons.icns' -Destination 'darwin/' -Force"
        {{else}}
        cp icon.ico windows/
        cp icons.icns darwin/
        {{end}}
      # Log success messages
      - task: common:log:success
        vars:
          MSG: "Icons generated: icons.icns, icon.ico"
      - task: common:log:success
        vars:
          MSG: "Platform icons: windows/icon.ico, darwin/icons.icns"

  generate:syso:
    label: "generate:syso"
    summary: Generate Windows resource file (.syso) with embedded icon (cross-platform)
    deps:
      - common:ensure:go
    sources:
      - "./windows/icon.ico"
    generates:
      - "../rsrc_windows_windows_amd64.syso"
    vars:
      # Get version from env, git tag, or default to 1.0.0
      # Cross-platform: Uses Taskfile template syntax instead of bash variable expansion
      VERSION: '{{.YANTA_VERSION | default ""}}'
    cmds:
      # Log start message
      - task: common:log:info
        vars:
          MSG: "Generating Windows resource file (.syso)..."
      # Ensure go-winres is installed (cross-platform)
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command "if (-not (Get-Command 'go-winres' -ErrorAction SilentlyContinue)) { Write-Host 'Installing go-winres...'; go install github.com/tc-hib/go-winres@latest }"
        {{else}}
        if ! which go-winres >/dev/null 2>&1; then
          echo "Installing go-winres..."
          go install github.com/tc-hib/go-winres@latest
        fi
        {{end}}
      # Get version and generate .syso file (cross-platform)
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command @'
          # Get version from environment, git tag, or default
          $Version = $env:YANTA_VERSION
          if (-not $Version) {
            try {
              $VersionTag = git describe --tags --abbrev=0 2>$null
              if ($VersionTag) {
                $Version = $VersionTag -replace '^v', ''
              }
            } catch {}
          }
          if (-not $Version) {
            $Version = "1.0.0"
          }
          Write-Host "Generating Windows resources (version: $Version)..."

          # Generate .syso file with embedded icon using go-winres
          go-winres simply `
            --icon build/windows/icon.ico `
            --out rsrc_windows `
            --arch amd64 `
            --manifest gui `
            --product-name "YANTA" `
            --file-description "YANTA - Yet Another Note Taking App" `
            --copyright "Copyright (c) 2024-2025 Omar Ahmed" `
            --original-filename "yanta.exe" `
            --product-version $Version `
            --file-version $Version

          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        '@
        {{else}}
        # Get version from environment, git tag, or default
        VERSION="${YANTA_VERSION:-}"
        if [ -z "$VERSION" ]; then
          VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null) || true
          if [ -n "$VERSION_TAG" ]; then
            VERSION="${VERSION_TAG#v}"
          fi
        fi
        if [ -z "$VERSION" ]; then
          VERSION="1.0.0"
        fi
        echo "Generating Windows resources (version: $VERSION)..."

        # Generate .syso file with embedded icon using go-winres
        go-winres simply \
          --icon build/windows/icon.ico \
          --out rsrc_windows \
          --arch amd64 \
          --manifest gui \
          --product-name "YANTA" \
          --file-description "YANTA - Yet Another Note Taking App" \
          --copyright "Copyright (c) 2024-2025 Omar Ahmed" \
          --original-filename "yanta.exe" \
          --product-version "$VERSION" \
          --file-version "$VERSION"
        {{end}}
      # Log success message
      - task: common:log:success
        vars:
          MSG: "Windows resources generated: rsrc_windows_windows_amd64.syso"

  generate:bindings:
    label: "generate:bindings"
    summary: Generate TypeScript bindings from Go services (cross-platform)
    silent: true
    deps:
      - ensure:wails
    sources:
      - "../**/*.go"
      - "../go.mod"
      - "../go.sum"
      - exclude: "../frontend/**/*"
    generates:
      - "../frontend/bindings/**/*"
    vars:
      # Cross-platform: Use Taskfile template syntax for default value
      GO_CACHE_DIR: '{{.GO_CACHE_DIR | default ".gocache"}}'
    cmds:
      # Log start message
      - task: common:log:info
        vars:
          MSG: "Generating TypeScript bindings from Go services..."
      # Cross-platform binding generation
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command @'
          # Check if binding generation should be skipped
          if ($env:SKIP_WAILS_BINDINGS -eq "1") {
            Write-Host "Skipping binding generation (SKIP_WAILS_BINDINGS=1)"
            exit 0
          }

          # Setup Go cache directory
          $GoCacheDir = if ($env:GO_CACHE_DIR) { $env:GO_CACHE_DIR } else { ".gocache" }
          if (-not [System.IO.Path]::IsPathRooted($GoCacheDir)) {
            $GoCacheDir = Join-Path (Get-Location) $GoCacheDir
          }
          if (-not (Test-Path $GoCacheDir)) {
            New-Item -ItemType Directory -Path $GoCacheDir -Force | Out-Null
          }

          # Run wails3 generate bindings with cache directory
          $env:GOCACHE = $GoCacheDir
          $env:GOFLAGS = ""
          wails3 generate bindings -clean=true -ts
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        '@
        {{else}}
        # Check if binding generation should be skipped (POSIX-compatible)
        if [ "${SKIP_WAILS_BINDINGS:-0}" = "1" ]; then
          echo "Skipping binding generation (SKIP_WAILS_BINDINGS=1)"
          exit 0
        fi

        # Setup Go cache directory (POSIX-compatible)
        GO_CACHE_DIR="${GO_CACHE_DIR:-.gocache}"
        case "$GO_CACHE_DIR" in
          /*) ;;
          *) GO_CACHE_DIR="$(pwd)/$GO_CACHE_DIR" ;;
        esac
        mkdir -p "$GO_CACHE_DIR"

        # Run wails3 generate bindings with cache directory
        GOCACHE="$GO_CACHE_DIR" GOFLAGS="" wails3 generate bindings -clean=true -ts
        {{end}}
      # Log success message
      - task: common:log:success
        vars:
          MSG: "TypeScript bindings generated successfully"

  # ============================================================================
  # Frontend Tasks
  # ============================================================================

  dev:frontend:
    summary: Run frontend dev server (Vite)
    silent: true
    dir: "{{.ROOT_DIR}}/frontend"
    deps:
      - common:ensure:npm
    env:
      WAILS_VITE_PORT: '{{.WAILS_VITE_PORT | default "34115"}}'
    cmds:
      - npm run dev

  # ============================================================================
  # Go Build (Core Build Logic)
  # Cross-platform: Uses Taskfile {{OS}} conditionals for Windows/Linux/macOS
  # ============================================================================

  go:build:
    summary: Build Go binary for specified target platform (cross-platform)
    desc: |
      Cross-platform: Uses Taskfile {{OS}} conditionals
      - On Windows: Uses PowerShell for all operations
      - On Linux/macOS: Uses POSIX-compatible shell
      Supports TARGET values: local, win, ubuntu, arch, osx
    internal: true
    silent: true
    deps:
      - common:ensure:go
      - common:ensure:npm
    vars:
      TARGET: '{{.TARGET | default "local"}}'
      DEBUG: '{{.DEBUG | default "0"}}'
      # Cross-platform: Use Taskfile default syntax
      GO_CACHE_DIR: '{{.GO_CACHE_DIR | default ".gocache"}}'
    cmds:
      # Ensure bin directory exists (cross-platform)
      - task: common:dir:ensure
        vars:
          DIR: '{{.BIN_DIR}}'
      # Log build start
      - task: common:log:info
        vars:
          MSG: "Starting Go build (TARGET={{.TARGET}}, DEBUG={{.DEBUG}})..."
      # Cross-platform build logic
      - |
        {{if eq OS "windows"}}
        powershell -NoProfile -Command @'
          $ErrorActionPreference = "Stop"

          # Setup Go cache directory
          $GoCacheDir = $env:GO_CACHE_DIR
          if (-not $GoCacheDir) { $GoCacheDir = ".gocache" }
          if (-not [System.IO.Path]::IsPathRooted($GoCacheDir)) {
            $GoCacheDir = Join-Path (Get-Location) $GoCacheDir
          }
          if (-not (Test-Path $GoCacheDir)) {
            New-Item -ItemType Directory -Path $GoCacheDir -Force | Out-Null
          }
          $env:GOCACHE = $GoCacheDir

          $Target = "{{.TARGET}}"
          $Debug = "{{.DEBUG}}"
          $AppName = "{{.APP_NAME}}"
          $BinDir = "{{.BIN_DIR}}"

          # Auto-detect target if "local" - on Windows, default to win
          if ([string]::IsNullOrEmpty($Target) -or $Target -eq "local") {
            $Target = "win"
          }

          # Platform-specific configuration
          $UseWebkit41 = $false
          $GoosTarget = ""
          $GoarchTarget = "amd64"
          $CcOverride = ""
          $CxxOverride = ""
          $OutputSuffix = ""
          $BuildTags = @()

          switch ($Target) {
            { $_ -in @("win", "windows") } {
              $GoosTarget = ""  # Native build on Windows
              $OutputSuffix = ".exe"
              $BuildTags = @()

              # Generate Windows resources (.syso) for icon embedding
              Write-Host "Generating Windows resources..."
              if (-not (Get-Command "go-winres" -ErrorAction SilentlyContinue)) {
                Write-Host "Installing go-winres..."
                go install github.com/tc-hib/go-winres@latest
              }

              # Get version for Windows resources
              $WinresVersion = $env:YANTA_VERSION
              if (-not $WinresVersion) {
                try {
                  $VersionTag = git describe --tags --abbrev=0 2>$null
                  if ($VersionTag) {
                    $WinresVersion = $VersionTag -replace "^v", ""
                  }
                } catch {}
              }
              if (-not $WinresVersion) { $WinresVersion = "1.0.0" }

              # Generate .syso file
              go-winres simply `
                --icon build/windows/icon.ico `
                --out rsrc_windows `
                --arch amd64 `
                --manifest gui `
                --product-name "YANTA" `
                --file-description "YANTA - Yet Another Note Taking App" `
                --copyright "Copyright (c) 2024-2025 Omar Ahmed" `
                --original-filename "yanta.exe" `
                --product-version $WinresVersion `
                --file-version $WinresVersion

              if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
              Write-Host "Windows resources generated (rsrc_windows_windows_amd64.syso)"
            }
            { $_ -in @("ubuntu", "arch") } {
              Write-Host "ERROR: Linux targets (ubuntu, arch) must be built on Linux" -ForegroundColor Red
              exit 1
            }
            { $_ -in @("osx", "mac", "macos") } {
              Write-Host "ERROR: macOS targets must be built on macOS" -ForegroundColor Red
              exit 1
            }
            default {
              Write-Host "ERROR: Unknown target: $Target" -ForegroundColor Red
              Write-Host "Valid targets: win, ubuntu, arch, osx"
              exit 1
            }
          }

          # Get version info
          $Commit = "unknown"
          try { $Commit = git rev-parse --short HEAD 2>$null } catch {}
          if ([string]::IsNullOrEmpty($Commit)) { $Commit = "unknown" }

          $Version = $env:YANTA_VERSION
          if (-not $Version) {
            try {
              $VersionTag = git describe --tags --abbrev=0 2>$null
              if ($VersionTag) {
                $Version = $VersionTag -replace "^v", ""
              }
            } catch {}
          }
          if (-not $Version) { $Version = "dev-$Commit" }

          $Date = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          # Build LD flags
          $LdFlags = "-X yanta/internal/system.BuildVersion=$Version"
          $LdFlags += " -X yanta/internal/system.BuildCommit=$Commit"
          $LdFlags += " -X yanta/internal/system.BuildDate=$Date"

          if ($Target -in @("win", "windows")) {
            $LdFlags += " -H=windowsgui"
          }

          Write-Host "========================================"
          Write-Host "Building: $AppName"
          Write-Host "Target:   $Target"
          Write-Host "Version:  $Version"
          Write-Host "Commit:   $Commit"
          Write-Host "========================================"

          # Setup output path
          $OutputPath = Join-Path $BinDir "$AppName$OutputSuffix"

          # Build environment
          $env:GOARCH = $GoarchTarget
          $env:CGO_ENABLED = "1"
          if ($GoosTarget) { $env:GOOS = $GoosTarget }
          if ($CcOverride) { $env:CC = $CcOverride; $env:CXX = $CxxOverride }

          # Debug mode
          if ($Debug -eq "1") {
            $env:YANTA_DEBUG_BUILD = "1"
            Write-Host "Debug mode enabled"
          }

          # Execute build
          Write-Host "Compiling Go binary..."
          $BuildArgs = @("-ldflags", $LdFlags, "-o", $OutputPath, ".")
          if ($BuildTags.Count -gt 0) {
            $TagsArg = $BuildTags -join ","
            $BuildArgs = @("-tags", $TagsArg) + $BuildArgs
          }
          & go build @BuildArgs
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          Write-Host "Build complete: $OutputPath"

          # Create Windows installer using NSIS (if available)
          if ($Target -in @("win", "windows")) {
            if (Get-Command "makensis" -ErrorAction SilentlyContinue) {
              Write-Host "Creating Windows installer..."
              $NsiDir = "build\windows\installer"
              $NsiFile = Join-Path $NsiDir "project.nsi"
              if (Test-Path $NsiFile) {
                $AbsNsiDir = (Resolve-Path $NsiDir).Path
                $AbsBinary = (Resolve-Path $OutputPath).Path
                & makensis "/X!addincludedir $AbsNsiDir" "-DARG_WAILS_AMD64_BINARY=$AbsBinary" $NsiFile
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "Windows installer created"
                } else {
                  Write-Host "WARNING: NSIS installer creation failed" -ForegroundColor Yellow
                }
              } else {
                Write-Host "WARNING: NSIS script not found at $NsiFile, skipping installer" -ForegroundColor Yellow
              }
            } else {
              Write-Host "Note: makensis not found, skipping installer creation"
            }
          }
        '@
        {{else}}
        # Unix (Linux/macOS) build
        # Setup Go cache directory (POSIX-compatible)
        GO_CACHE_DIR="${GO_CACHE_DIR:-.gocache}"
        case "$GO_CACHE_DIR" in
          /*) ;;
          *) GO_CACHE_DIR="$(pwd)/$GO_CACHE_DIR" ;;
        esac
        mkdir -p "$GO_CACHE_DIR"
        export GOCACHE="$GO_CACHE_DIR"

        TARGET="{{.TARGET}}"
        DEBUG="{{.DEBUG}}"
        APP_NAME="{{.APP_NAME}}"
        BIN_DIR="{{.BIN_DIR}}"

        # Detect host platform using uname (available on all Unix systems)
        HOST_UNAME=$(uname -s | tr '[:upper:]' '[:lower:]')

        # Auto-detect target if "local"
        if [ -z "$TARGET" ] || [ "$TARGET" = "local" ]; then
          case "$HOST_UNAME" in
            linux) TARGET="ubuntu" ;;
            darwin) TARGET="osx" ;;
            *) TARGET="ubuntu" ;;
          esac
        fi

        # Platform-specific configuration
        USE_WEBKIT41=false
        GOOS_TARGET=""
        GOARCH_TARGET="amd64"
        CC_OVERRIDE=""
        CXX_OVERRIDE=""
        OUTPUT_SUFFIX=""
        BUILD_TAGS=""

        case "$TARGET" in
          win|windows)
            GOOS_TARGET="windows"
            OUTPUT_SUFFIX=".exe"

            # Generate Windows resources (.syso) for icon embedding
            echo "Generating Windows resources..."
            if ! which go-winres >/dev/null 2>&1; then
              echo "Installing go-winres..."
              go install github.com/tc-hib/go-winres@latest
            fi

            # Get version for Windows resources
            WINRES_VERSION="1.0.0"
            if [ -n "${YANTA_VERSION:-}" ]; then
              WINRES_VERSION="${YANTA_VERSION}"
            else
              WINRES_VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null) || true
              if [ -n "$WINRES_VERSION_TAG" ]; then
                WINRES_VERSION="${WINRES_VERSION_TAG#v}"
              fi
            fi

            # Generate .syso file with embedded icon
            go-winres simply \
              --icon build/windows/icon.ico \
              --out rsrc_windows \
              --arch amd64 \
              --manifest gui \
              --product-name "YANTA" \
              --file-description "YANTA - Yet Another Note Taking App" \
              --copyright "Copyright (c) 2024-2025 Omar Ahmed" \
              --original-filename "yanta.exe" \
              --product-version "$WINRES_VERSION" \
              --file-version "$WINRES_VERSION"

            echo "Windows resources generated (rsrc_windows_windows_amd64.syso)"

            if [ "$HOST_UNAME" = "linux" ]; then
              echo "Building Windows target on Linux (MinGW cross-compile)..."
              # Ensure MinGW is available
              if ! which x86_64-w64-mingw32-gcc >/dev/null 2>&1; then
                echo "ERROR: MinGW not found. Install: sudo apt-get install -y mingw-w64" >&2
                exit 1
              fi
              CC_OVERRIDE="x86_64-w64-mingw32-gcc"
              CXX_OVERRIDE="x86_64-w64-mingw32-g++"
            else
              echo "ERROR: Windows builds must run on Windows or Linux (with MinGW)" >&2
              exit 1
            fi
            ;;

          ubuntu)
            # Verify we're on Linux
            if [ "$HOST_UNAME" != "linux" ]; then
              echo "ERROR: Ubuntu target requires Linux host (current: $HOST_UNAME)" >&2
              exit 1
            fi
            GOOS_TARGET="linux"
            USE_WEBKIT41=true
            BUILD_TAGS="-tags webkit2_41"
            ;;

          arch)
            # Verify we're on Linux
            if [ "$HOST_UNAME" != "linux" ]; then
              echo "ERROR: Arch target requires Linux host (current: $HOST_UNAME)" >&2
              exit 1
            fi
            GOOS_TARGET="linux"
            USE_WEBKIT41=true
            BUILD_TAGS="-tags webkit2_41"
            ;;

          osx|mac|macos)
            # Verify we're on macOS
            if [ "$HOST_UNAME" != "darwin" ]; then
              echo "ERROR: macOS target requires macOS host (current: $HOST_UNAME)" >&2
              exit 1
            fi
            GOOS_TARGET="darwin"
            ;;

          *)
            echo "ERROR: Unknown target: $TARGET" >&2
            echo "Valid targets: win, ubuntu, arch, osx" >&2
            exit 1
            ;;
        esac

        # Get version info
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        VERSION="${YANTA_VERSION:-}"
        if [ -z "$VERSION" ]; then
          VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null) || true
          if [ -n "$VERSION_TAG" ]; then
            VERSION="${VERSION_TAG#v}"
          fi
        fi
        if [ -z "$VERSION" ]; then
          VERSION="dev-${COMMIT}"
        fi
        DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Build LD flags
        LD_FLAGS="-X yanta/internal/system.BuildVersion=${VERSION}"
        LD_FLAGS="$LD_FLAGS -X yanta/internal/system.BuildCommit=${COMMIT}"
        LD_FLAGS="$LD_FLAGS -X yanta/internal/system.BuildDate=${DATE}"

        case "$TARGET" in
          win|windows)
            LD_FLAGS="$LD_FLAGS -H=windowsgui"
            ;;
        esac

        echo "========================================"
        echo "Building: $APP_NAME"
        echo "Target:   $TARGET"
        echo "Version:  $VERSION"
        echo "Commit:   $COMMIT"
        echo "========================================"

        # Setup output path
        OUTPUT_PATH="${BIN_DIR}/${APP_NAME}${OUTPUT_SUFFIX}"

        # Build with proper environment
        export GOARCH="$GOARCH_TARGET"
        export CGO_ENABLED=1
        if [ -n "$GOOS_TARGET" ]; then
          export GOOS="$GOOS_TARGET"
        fi
        if [ -n "$CC_OVERRIDE" ]; then
          export CC="$CC_OVERRIDE"
          export CXX="$CXX_OVERRIDE"
        fi

        # Debug mode
        if [ "$DEBUG" = "1" ]; then
          export YANTA_DEBUG_BUILD=1
          echo "Debug mode enabled"
        fi

        # Execute build
        echo "Compiling Go binary..."
        if [ -n "$BUILD_TAGS" ]; then
          go build $BUILD_TAGS -ldflags "$LD_FLAGS" -o "$OUTPUT_PATH" .
        else
          go build -ldflags "$LD_FLAGS" -o "$OUTPUT_PATH" .
        fi

        echo "Build complete: $OUTPUT_PATH"

        # Cross-compiling Windows from Linux - skip installer
        case "$TARGET" in
          win|windows)
            echo "Note: Cross-compiling Windows binary from Linux, installer must be created on Windows"
            ;;
        esac

        # Create macOS .app bundle (only on macOS host)
        case "$TARGET" in
          osx|mac|macos)
            echo "Creating macOS .app bundle..."
            APP_DIR="${BIN_DIR}/${APP_NAME}.app"
            CONTENTS_DIR="$APP_DIR/Contents"
            MACOS_DIR="$CONTENTS_DIR/MacOS"
            RESOURCES_DIR="$CONTENTS_DIR/Resources"

            mkdir -p "$MACOS_DIR" "$RESOURCES_DIR"
            cp "$OUTPUT_PATH" "$MACOS_DIR/${APP_NAME}"

            # Create Info.plist
            /usr/libexec/PlistBuddy -c "Clear dict" "$CONTENTS_DIR/Info.plist" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundlePackageType string APPL" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleName string YANTA" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string YANTA" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string ${APP_NAME}" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string com.omarahmed.yanta" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string ${VERSION}" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string ${VERSION}" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleGetInfoString string Yet Another Note Taking App" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :CFBundleIconFile string iconfile" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :LSMinimumSystemVersion string 10.15" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :NSHighResolutionCapable bool true" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :NSHumanReadableCopyright string Copyright 2024-2025 Omar Ahmed" "$CONTENTS_DIR/Info.plist"
            /usr/libexec/PlistBuddy -c "Add :NSSupportsAutomaticGraphicsSwitching bool true" "$CONTENTS_DIR/Info.plist"

            # Copy icon if exists
            if [ -f "build/darwin/icons.icns" ]; then
              cp "build/darwin/icons.icns" "$RESOURCES_DIR/iconfile.icns"
            fi

            # Sign the app bundle
            codesign --force --deep --sign - "$APP_DIR"
            echo "macOS .app bundle created: $APP_DIR"
            ;;
        esac
        {{end}}
      # Log build completion
      - task: common:log:success
        vars:
          MSG: "Go build completed for target {{.TARGET}}"

  # ============================================================================
  # Wails Build (alternative build method using wails3)
  # ============================================================================

  wails:build:
    summary: Build using wails3 build command (alternative method)
    deps:
      - ensure:wails
    vars:
      PLATFORM: '{{.PLATFORM | default ""}}'
      EXTRA_FLAGS: '{{.EXTRA_FLAGS | default ""}}'
    cmds:
      - |
        set -euo pipefail
        if [ -n "{{.EXTRA_FLAGS}}" ]; then
          wails3 build {{.EXTRA_FLAGS}}
        else
          wails3 build
        fi
